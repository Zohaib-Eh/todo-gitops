name: Deploy To Do List App Front-End
on:
  push:
    branches:
    - main
    
jobs: 
  my_job:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: frontend
    steps:
    -  uses: actions/checkout@v4
    
    -  name: Set up Node.js
       uses: actions/setup-node@v4
       with:
            node-version: '20'
  
    -  name: Install Dependencies
       run: npm ci
  
    -  name: Build
       run: npm run build
       
    -  name: Deploy to S3
       run: |
         aws s3 sync dist/ s3://react-todo-workshop/ --delete
         aws s3 cp dist/ s3://react-todo-workshop/ --recursive --exclude "*" --include "*.js" --content-type "application/javascript" --metadata-directive REPLACE
         aws s3 cp dist/ s3://react-todo-workshop/ --recursive --exclude "*" --include "*.css" --content-type "text/css" --metadata-directive REPLACE
         aws s3 cp dist/ s3://react-todo-workshop/ --recursive --exclude "*" --include "*.html" --content-type "text/html" --metadata-directive REPLACE
         aws s3 cp dist/ s3://react-todo-workshop/ --recursive --exclude "*" --include "*.svg" --content-type "image/svg+xml" --metadata-directive REPLACE
         aws s3 cp dist/ s3://react-todo-workshop/ --recursive --exclude "*" --include "*.json" --content-type "application/json" --metadata-directive REPLACE
       env:
         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         AWS_REGION: eu-west-1
         AWS_EC2_METADATA_DISABLED: true
   
    -  name: Invalidate CloudFront cache
       run: aws cloudfront create-invalidation --distribution-id E179NKVJMRYRAL --paths "/*"
       env:
         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         AWS_REGION: eu-west-1
         AWS_EC2_METADATA_DISABLED: true
